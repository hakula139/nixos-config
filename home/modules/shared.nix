{
  config,
  pkgs,
  lib,
  ...
}:

# ==============================================================================
# Shared Environment
# ==============================================================================

let
  tooling = import ../../lib/tooling.nix { inherit pkgs; };
in
{
  # ============================================================================
  # Files (shared)
  # ============================================================================
  home.file = {
    ".editorconfig".source = ../../.editorconfig;
    "ruff.toml".source = ../../ruff.toml;
  };

  # ============================================================================
  # Packages (shared)
  # ============================================================================
  home.packages =
    with pkgs;
    [
      # ------------------------------------------------------------------------
      # Everyday CLI
      # ------------------------------------------------------------------------
      bat
      btop
      eza
      fd
      fzf
      ripgrep
      zoxide

      # ------------------------------------------------------------------------
      # Archive & Compression
      # ------------------------------------------------------------------------
      unzip
      p7zip

      # ------------------------------------------------------------------------
      # Bash Development
      # ------------------------------------------------------------------------
      bash-language-server
      shellcheck
      shfmt

      # ------------------------------------------------------------------------
      # C/C++ Development
      # ------------------------------------------------------------------------
      llvmPackages.clang
      llvmPackages.clang-tools
      llvmPackages.lld
      llvmPackages.lldb
      cppcheck
      ccache
      cmake
      gnumake
      ninja
      pkg-config
      doxygen

      # ------------------------------------------------------------------------
      # Python Development
      # ------------------------------------------------------------------------
      python3
      python3Packages.pip
      pipx
      poetry
      ruff
      uv

      # ------------------------------------------------------------------------
      # Node.js Development
      # ------------------------------------------------------------------------
      fnm

      # ------------------------------------------------------------------------
      # Go Development
      # ------------------------------------------------------------------------
      go
      gopls

      # ------------------------------------------------------------------------
      # Rust Development
      # ------------------------------------------------------------------------
      rustup

      # ------------------------------------------------------------------------
      # Java Development
      # ------------------------------------------------------------------------
      jdk21

      # ------------------------------------------------------------------------
      # Haskell Development
      # ------------------------------------------------------------------------
      ghc
      cabal-install
      stack

      # ------------------------------------------------------------------------
      # Containers & Kubernetes
      # ------------------------------------------------------------------------
      podman
      podman-compose
      kubectl
      kubernetes-helm
      k9s
      kubectx

      # ------------------------------------------------------------------------
      # Other Tools
      # ------------------------------------------------------------------------
      git-filter-repo
      jq
      yq
      httpie
      scc
    ]
    ++ tooling.nix
    ++ tooling.secrets;

  # ============================================================================
  # Environment Variables (shared)
  # ============================================================================
  home.sessionVariables = {
    # Node.js
    PNPM_HOME = "${config.xdg.dataHome}/pnpm";

    # Go
    GOPATH = "$HOME/go";

    # Rust
    RUSTUP_HOME = "$HOME/.rustup";
    CARGO_HOME = "$HOME/.cargo";
    RUSTUP_UPDATE_ROOT = "https://mirrors.tuna.tsinghua.edu.cn/rustup/rustup";
    RUSTUP_DIST_SERVER = "https://mirrors.tuna.tsinghua.edu.cn/rustup";
  };

  # ============================================================================
  # PATH additions (shared)
  # ============================================================================
  home.sessionPath = [
    "${config.xdg.dataHome}/pnpm"
    "$HOME/go/bin"
    "$HOME/.cargo/bin"
    "$HOME/.local/bin"
  ];

  # ============================================================================
  # Shell Configuration (shared)
  # ============================================================================
  programs.zsh.initContent = lib.mkAfter ''
    # --------------------------------------------------------------------------
    # fnm (Fast Node Manager) - replacement for nvm
    # Use `fnm use <version>` to switch Node.js versions.
    # --------------------------------------------------------------------------
    if command -v fnm &>/dev/null; then
      eval "$(fnm env --use-on-cd)"
    fi

    # --------------------------------------------------------------------------
    # Corepack - Enable pnpm with per-project version management
    # --------------------------------------------------------------------------
    if command -v corepack &>/dev/null; then
      corepack enable pnpm 2>/dev/null
    fi
  '';
}
